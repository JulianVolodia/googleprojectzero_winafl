# Vulnerability Hunting Guide with WinAFL

## Table of Contents

1. [Introduction](#introduction)
2. [Prerequisites](#prerequisites)
3. [Setup and Installation](#setup-and-installation)
4. [Target Selection](#target-selection)
5. [Fuzzing Strategy](#fuzzing-strategy)
6. [Analyzing Results](#analyzing-results)
7. [Reporting to Microsoft](#reporting-to-microsoft)
8. [Advanced Techniques](#advanced-techniques)
9. [Best Practices](#best-practices)
10. [Troubleshooting](#troubleshooting)

## Introduction

This guide will help you use WinAFL (Windows AFL) to discover vulnerabilities in Windows software, specifically targeting Microsoft products for responsible disclosure.

### What is WinAFL?

WinAFL is a Windows port of AFL (American Fuzzy Lop), a coverage-guided fuzzer developed by Michal Zalewski. It uses DynamoRIO for dynamic instrumentation and supports both 32-bit and 64-bit Windows targets.

### Ethical Considerations

**IMPORTANT:** This guide is for authorized security research only. You must:

- Only test software you have permission to test
- Follow responsible disclosure practices
- Never use found vulnerabilities maliciously
- Report findings to vendors before public disclosure
- Respect Microsoft's bug bounty program rules

## Prerequisites

### Hardware Requirements

- **CPU:** Multi-core processor (recommended: 4+ cores)
- **RAM:** Minimum 8GB (recommended: 16GB+)
- **Storage:** 50GB+ free space for fuzzing campaigns

### Software Requirements

- Windows 10/11 (64-bit recommended)
- PowerShell 5.0 or later
- Visual Studio 2019+ (for building from source)
- WinDbg (Windows Debugger) - for crash analysis
- Administrator privileges

### Knowledge Requirements

- Basic understanding of:
  - Fuzzing concepts
  - Windows PE format
  - Assembly/debugging basics
  - Vulnerability types (buffer overflows, use-after-free, etc.)

## Setup and Installation

### Quick Start

1. **Clone or download this repository:**
   ```powershell
   git clone https://github.com/YourRepo/winafl.git
   cd winafl
   ```

2. **Run the setup script:**
   ```powershell
   PowerShell -ExecutionPolicy Bypass -File setup_winafl.ps1
   ```

3. **Restart your PowerShell session** to apply environment changes.

### Manual Setup

If the automated setup fails, follow these steps:

#### 1. Download DynamoRIO

```powershell
# Create directory
New-Item -ItemType Directory -Path "C:\fuzzing\DynamoRIO" -Force

# Download from: https://github.com/DynamoRIO/dynamorio/releases
# Extract to C:\fuzzing\DynamoRIO
```

#### 2. Copy WinAFL Binaries

```powershell
# For 64-bit targets
Copy-Item -Path ".\bin64\*" -Destination "C:\fuzzing\winafl" -Force

# For 32-bit targets
Copy-Item -Path ".\bin32\*" -Destination "C:\fuzzing\winafl" -Force
```

#### 3. Set Environment Variables

```powershell
[Environment]::SetEnvironmentVariable("WINAFL_DIR", "C:\fuzzing\winafl", "Machine")
[Environment]::SetEnvironmentVariable("DYNAMORIO_DIR", "C:\fuzzing\DynamoRIO", "Machine")
```

### Verify Installation

```powershell
# Check WinAFL
C:\fuzzing\winafl\afl-fuzz.exe

# Check DynamoRIO
C:\fuzzing\DynamoRIO\bin64\drrun.exe -version
```

## Target Selection

### Prioritizing Targets

When choosing targets for vulnerability hunting, consider:

1. **Attack Surface:**
   - File parsers (images, documents, media)
   - Network protocol handlers
   - Compression/decompression libraries
   - Font renderers

2. **Impact:**
   - System-level services
   - Default Windows applications
   - Widely-used components

3. **Complexity:**
   - Complex parsing logic
   - Memory management
   - Multi-threaded code

### High-Value Microsoft Targets

#### Built-in Windows Applications

| Application | Target | File Types | Priority |
|-------------|--------|------------|----------|
| MS Paint | mspaint.exe, gdiplus.dll | BMP, PNG, JPG, GIF | High |
| WordPad | wordpad.exe, riched20.dll | RTF, DOC, DOCX | High |
| Windows Media Player | wmplayer.exe | WMA, WMV, AVI, MP3 | High |
| Internet Explorer | iexplore.exe, mshtml.dll | HTML, JS | Medium |
| Windows Photo Viewer | PhotoViewer.dll | JPG, PNG, TIFF | High |
| Windows Shell | explorer.exe, shell32.dll | Various | Critical |

#### System Libraries

| Library | Purpose | Priority |
|---------|---------|----------|
| gdiplus.dll | Image processing | High |
| WindowsCodecs.dll | Codec handling | High |
| mshtml.dll | HTML rendering | High |
| urlmon.dll | URL processing | Medium |
| ole32.dll | OLE/COM | High |
| kernel32.dll | Core Windows API | Critical |

### Finding Target Functions

Use these tools to identify fuzzing targets:

#### 1. Using WinDbg

```
windbg target.exe

# List all modules
lm

# Find exported functions
x module!*

# Find specific function
x module!FunctionName

# Get function offset
? FunctionAddress - module_base
```

#### 2. Using IDA Pro / Ghidra

- Load the target binary
- Identify file parsing functions
- Look for:
  - `Read*` functions
  - `Parse*` functions
  - `Load*` functions
  - `Decode*` functions

#### 3. Using Process Monitor

- Monitor file access
- Identify which modules handle specific file types
- Track function calls during file opening

## Fuzzing Strategy

### Step 1: Prepare Test Cases

Create a corpus of valid input files:

```powershell
# Create input directory
New-Item -ItemType Directory -Path "C:\fuzzing\input" -Force

# Add valid test files
# For images: small valid BMP, PNG, JPG files
# For documents: small valid RTF, DOC files
# For media: small valid MP3, WMV files
```

**Best Practices:**
- Use small files (< 10KB) for faster execution
- Include files with various features
- Collect from different sources
- Ensure files are valid and parse correctly

### Step 2: Test in Debug Mode

Always test your configuration first:

```powershell
.\fuzz_target.ps1 `
    -TargetExe "C:\Windows\System32\mspaint.exe" `
    -TargetModule "gdiplus.dll" `
    -TargetOffset "0x1270" `
    -CoverageModule "gdiplus.dll" `
    -Debug
```

**What to look for:**
- Target runs successfully 10 times
- Input file is opened repeatedly
- No errors in the log file
- Coverage information is recorded

### Step 3: Start Fuzzing

Launch a full fuzzing campaign:

```powershell
.\fuzz_target.ps1 `
    -TargetExe "C:\Windows\System32\mspaint.exe" `
    -TargetModule "gdiplus.dll" `
    -TargetOffset "0x1270" `
    -CoverageModule "gdiplus.dll,WindowsCodecs.dll" `
    -InputDir "C:\fuzzing\input\bmp" `
    -OutputDir "C:\fuzzing\output\mspaint_gdiplus" `
    -Timeout 20000 `
    -Iterations 5000
```

### Step 4: Monitor Fuzzing

**AFL Status Screen:**
- **exec speed:** executions per second (higher is better)
- **pending:** new test cases to process
- **cycles done:** completion count (aim for 10+)
- **unique crashes:** distinct crashes found
- **unique hangs:** distinct hangs found

**Performance Tips:**
- Target 100+ exec/s
- Use multiple cores (start multiple instances)
- Increase iterations for faster targets
- Reduce timeout for responsive applications

### Distributed Fuzzing

Run multiple fuzzing instances:

```powershell
# Master instance
.\fuzz_target.ps1 -M master ...

# Slave instances (in separate terminals)
.\fuzz_target.ps1 -S slave1 ...
.\fuzz_target.ps1 -S slave2 ...
.\fuzz_target.ps1 -S slave3 ...
```

## Analyzing Results

### Step 1: Check for Crashes

```powershell
.\analyze_crashes.ps1 `
    -OutputDir "C:\fuzzing\output\mspaint_gdiplus" `
    -TargetExe "C:\Windows\System32\mspaint.exe" `
    -GenerateReport
```

### Step 2: Manual Verification

Reproduce crashes manually:

```powershell
# Try to open crash file
& "C:\Windows\System32\mspaint.exe" "C:\fuzzing\output\mspaint_gdiplus\crashes\id:000000,sig:06,src:000000,op:havoc,rep:2"
```

### Step 3: Debug with WinDbg

```powershell
# Launch WinDbg
windbg "C:\Windows\System32\mspaint.exe" crash_file.bmp

# Common commands:
# g - run
# .ecxr - show exception context
# kv - show call stack
# !analyze -v - detailed analysis
# r - show registers
# u - disassemble
```

### Step 4: Classify the Vulnerability

Identify the vulnerability type:

#### Common Vulnerability Types

1. **Buffer Overflow**
   - Stack buffer overflow
   - Heap buffer overflow
   - Integer overflow leading to buffer overflow

2. **Memory Corruption**
   - Use-after-free
   - Double-free
   - Null pointer dereference

3. **Denial of Service**
   - Infinite loop
   - Resource exhaustion
   - Stack exhaustion

4. **Logic Errors**
   - Format string vulnerabilities
   - Path traversal
   - Race conditions

### Step 5: Assess Severity

Use CVSS (Common Vulnerability Scoring System):

| Factor | Questions to Ask |
|--------|-----------------|
| **Attack Vector** | Network, Adjacent, Local, Physical? |
| **Attack Complexity** | Low or High? |
| **Privileges Required** | None, Low, High? |
| **User Interaction** | None or Required? |
| **Scope** | Unchanged or Changed? |
| **Confidentiality Impact** | None, Low, High? |
| **Integrity Impact** | None, Low, High? |
| **Availability Impact** | None, Low, High? |

**Severity Levels:**
- **Critical (9.0-10.0):** Remote code execution without user interaction
- **High (7.0-8.9):** RCE with user interaction, or privilege escalation
- **Medium (4.0-6.9):** Information disclosure, limited DoS
- **Low (0.1-3.9):** Minor issues with limited impact

### Step 6: Minimize Test Case

Make the crash file as small as possible:

```powershell
# Using afl-tmin (if available)
afl-tmin.exe -i crash_file.bmp -o minimized.bmp -- target.exe @@
```

Or manually:
1. Remove bytes from the end
2. Test if crash still occurs
3. Repeat until minimal

## Reporting to Microsoft

### Microsoft Security Response Center (MSRC)

#### 1. Prepare Your Report

Include:

**Required Information:**
- Product name and version
- Vulnerability type
- Impact assessment
- Steps to reproduce
- Proof-of-concept (crash file)
- WinDbg crash analysis

**Optional but Helpful:**
- Root cause analysis
- Suggested fix
- Additional notes

#### 2. Submit to MSRC

**Online Portal:**
https://msrc.microsoft.com/create-report

**Email:**
secure@microsoft.com

**PGP Key:**
https://www.microsoft.com/en-us/msrc/pgp-key-msrc

#### 3. Report Template

```markdown
# Vulnerability Report

## Summary
[Brief description of the vulnerability]

## Product Information
- Product: [e.g., Microsoft Paint]
- Version: [e.g., Windows 10 21H2]
- Component: [e.g., gdiplus.dll]
- Architecture: [32-bit / 64-bit]

## Vulnerability Details
- Type: [e.g., Heap Buffer Overflow]
- Severity: [Critical/High/Medium/Low]
- CVSS Score: [X.X]
- CWE: [CWE-XXX]

## Impact
[Describe potential impact: RCE, DoS, information disclosure, etc.]

## Reproduction Steps
1. Open [application]
2. Load the attached POC file
3. Observe crash

## Technical Analysis
[Include WinDbg output, call stack, registers, disassembly]

## Proof of Concept
[Attach minimized crash file or provide hash]
File hash (SHA256): [hash]

## Timeline
- Discovery Date: [YYYY-MM-DD]
- Vendor Notification: [YYYY-MM-DD]
- Public Disclosure: [90 days from notification]

## Researcher Information
Name: [Your Name]
Email: [Your Email]
Twitter/GitHub: [Optional]
```

### Response Timeline

**What to Expect:**

- **Day 1-7:** Acknowledgment from MSRC
- **Day 7-30:** Case assessment and triage
- **Day 30-90:** Investigation and patch development
- **Day 90+:** Patch release and public disclosure

### Bug Bounty Program

Microsoft offers bounties for eligible vulnerabilities:

**Website:**
https://www.microsoft.com/en-us/msrc/bounty

**Eligible Products:**
- Windows 10/11
- Microsoft Edge
- Microsoft Office
- Microsoft Azure
- Other Microsoft products

**Bounty Ranges:**
- **Critical:** $10,000 - $250,000+
- **High:** $5,000 - $50,000
- **Medium:** $500 - $5,000

**Ineligible:**
- Denial of Service only
- Issues in deprecated products
- Theoretical vulnerabilities
- Social engineering

## Advanced Techniques

### Custom Dictionaries

Create a dictionary for better mutations:

```
# image_magic.dict
header_bmp="BM"
header_png="\x89PNG"
header_jpg="\xFF\xD8\xFF"
header_gif="GIF89a"
size_field="\x00\x00\x10\x00"
```

Use with:
```powershell
.\fuzz_target.ps1 -x "C:\fuzzing\dictionaries\image_magic.dict" ...
```

### Persistent Mode Optimization

For maximum speed, identify functions that can be called repeatedly:

1. Find initialization-free functions
2. Identify cleanup routines
3. Configure target to loop within process

### Coverage Feedback Analysis

Monitor coverage to identify interesting areas:

```powershell
# Check unique paths discovered
Get-Content "C:\fuzzing\output\fuzzer_stats" | Select-String "paths_total"

# Visualize with afl-plot (if available)
afl-plot "C:\fuzzing\output" "C:\fuzzing\plots"
```

### Targeted Mutations

Focus on specific file structures:

- Magic bytes (file headers)
- Size fields
- Offsets and pointers
- Checksums
- Compressed data

### Address Sanitizer (ASan)

For better crash detection, compile targets with ASan:

```powershell
# In Visual Studio:
# Project Properties → C/C++ → General → Enable Address Sanitizer
```

## Best Practices

### Do's

✅ **Start small:** Test with simple inputs first
✅ **Monitor resources:** Watch CPU, RAM, and disk usage
✅ **Save everything:** Keep all crash files and logs
✅ **Document thoroughly:** Record all steps and findings
✅ **Minimize test cases:** Smaller PoCs are better
✅ **Verify crashes:** Ensure reproducibility
✅ **Follow responsible disclosure:** Give vendors time to patch
✅ **Use latest versions:** Test current software versions
✅ **Backup your work:** Fuzzing campaigns can be time-consuming

### Don'ts

❌ **Don't fuzz production systems:** Use test environments
❌ **Don't publish before disclosure:** Wait for patches
❌ **Don't skip verification:** Ensure crashes are real
❌ **Don't ignore hangs:** They can be vulnerabilities too
❌ **Don't test without permission:** Always authorize your testing
❌ **Don't share exploits:** Report to vendors first
❌ **Don't overwhelm MSRC:** One well-documented report is better than many poor ones

### Performance Optimization

1. **Use SSD storage** for fuzzing directories
2. **Disable antivirus** on fuzzing directories (carefully!)
3. **Use RAM disk** for temporary files
4. **Increase file handle limit**
5. **Use multiple CPU cores**
6. **Optimize iteration count** based on target speed

### Long-Running Campaigns

For multi-day fuzzing:

```powershell
# Create a scheduled task
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" `
    -Argument "-ExecutionPolicy Bypass -File C:\fuzzing\fuzz_target.ps1 ..."
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "WinAFL_Campaign"
```

## Troubleshooting

### Common Issues

#### Issue: "Error connecting to pipe"

**Solution:**
```powershell
# Check if another fuzzer is running
Get-Process afl-fuzz

# Kill existing processes
Stop-Process -Name "afl-fuzz" -Force

# Clean up shared memory
# Restart your system if needed
```

#### Issue: Low execution speed (< 10 exec/s)

**Solutions:**
- Reduce timeout value
- Decrease iteration count
- Use smaller input files
- Check for I/O bottlenecks
- Verify target is in persistent mode

#### Issue: No crashes after days of fuzzing

**Possibilities:**
- Target is well-hardened
- Input corpus is poor quality
- Coverage is limited
- Target is too simple

**Try:**
- Different input corpus
- Different target functions
- Dictionary-based fuzzing
- Longer campaigns (weeks/months)

#### Issue: "Cannot find target module"

**Solution:**
```powershell
# Run in debug mode to see loaded modules
.\fuzz_target.ps1 -Debug

# Check the .log file for module names
Get-Content "*.log" | Select-String "Module loaded"
```

#### Issue: WinDbg shows "Unable to load symbols"

**Solution:**
```powershell
# Set symbol path
.sympath srv*c:\symbols*http://msdl.microsoft.com/download/symbols

# Reload symbols
.reload /f
```

### Getting Help

- **WinAFL Issues:** https://github.com/googleprojectzero/winafl/issues
- **DynamoRIO Docs:** http://dynamorio.org/docs/
- **AFL Docs:** http://lcamtuf.coredump.cx/afl/
- **Microsoft MSRC:** https://www.microsoft.com/en-us/msrc

## Appendix

### Useful Commands Reference

#### PowerShell

```powershell
# Kill all fuzzing processes
Get-Process | Where-Object {$_.ProcessName -like "*afl*"} | Stop-Process -Force

# Check fuzzing statistics
Get-Content "C:\fuzzing\output\fuzzer_stats"

# Count crashes
(Get-ChildItem "C:\fuzzing\output\crashes").Count

# Find large crash files
Get-ChildItem "C:\fuzzing\output\crashes" | Sort-Object Length -Descending | Select-Object -First 10
```

#### WinDbg

```
# Essential commands
g                    # Run
.ecxr               # Exception context
kv                  # Call stack
!analyze -v         # Detailed analysis
r                   # Registers
u                   # Disassemble
db/dw/dd/dq         # Display memory
bp                  # Set breakpoint
bl                  # List breakpoints
bc                  # Clear breakpoint
.restart            # Restart debugging
q                   # Quit
```

### Resources

#### Documentation
- WinAFL README: [./README](./README)
- AFL User Guide: http://lcamtuf.coredump.cx/afl/
- DynamoRIO API: http://dynamorio.org/docs/API_BT.html

#### Tools
- WinDbg: https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/
- IDA Pro: https://www.hex-rays.com/products/ida/
- Ghidra: https://ghidra-sre.org/
- Process Monitor: https://docs.microsoft.com/en-us/sysinternals/downloads/procmon

#### Learning Resources
- Fuzzing Book: https://www.fuzzingbook.org/
- Nightmare CTF Course: https://guyinatuxedo.github.io/
- Modern Binary Exploitation: https://github.com/RPISEC/MBE

### Glossary

- **AFL:** American Fuzzy Lop - coverage-guided fuzzer
- **Coverage:** Code paths exercised during execution
- **Corpus:** Collection of input test cases
- **Crash:** Abnormal program termination
- **DynamoRIO:** Dynamic binary instrumentation framework
- **Fuzzing:** Automated testing with generated/mutated inputs
- **Hang:** Program that doesn't respond within timeout
- **Instrumentation:** Code added to track execution
- **MSRC:** Microsoft Security Response Center
- **Mutation:** Modification of input data
- **Persistent Mode:** Fuzzing without process restart
- **PoC:** Proof of Concept - minimal crash reproduction
- **Seed:** Initial input for fuzzing
- **Test Case:** Input that triggers specific behavior
- **Triage:** Classification and prioritization of crashes

---

**Good luck with your vulnerability hunting!**

Remember: Always practice responsible disclosure and ethical security research.
